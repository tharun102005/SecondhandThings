<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy Products</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#f1f3f6;
}

/* HEADER */
.header{
    background:#2874f0;
    padding:12px 18px;
    display:flex;
    align-items:center;
    color:white;
    position:sticky;
    top:0;
    z-index:1000;
    box-shadow:0 2px 8px rgba(40,116,240,0.12);
    gap:12px;
    flex-wrap:wrap;
}

.logo{
    font-size:20px;
    font-weight:700;
    margin-right:12px;
    color:white;
    letter-spacing:0.3px;
}

.search-box{
    flex:1;
    display:flex;
    gap:8px;
}

.search-box{
    flex:1 1 480px;
    display:flex;
    gap:8px;
    align-items:center;
    background:transparent;
}
.search-box input,
.search-box select,
.search-box button{
    padding:10px 12px;
    border-radius:6px;
    border:1px solid rgba(0,0,0,0.08);
    font-size:14px;
    background: #fff;
}
.search-box input{ flex:1 1 220px; min-width:120px }
.search-box input::placeholder{ color:#999 }
.search-box select{ width:140px }
.search-box button{
    background:#fff;
    color:#2874f0;
    border:1px solid rgba(0,0,0,0.08);
    cursor:pointer;
    font-weight:600;
}

.profile-menu{
    position:relative;
}

.profile-img{
    width:38px;
    height:38px;
    border-radius:50%;
    cursor:pointer;
    border:2px solid rgba(255,255,255,0.9);
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    object-fit:cover;
}

.profile-dropdown{
    display:none;
    position:absolute;
    right:0;
    top:42px;
    background:white;
    border-radius:8px;
    width:160px;
    box-shadow:0 4px 12px rgba(0,0,0,.2);
}

.profile-dropdown a{
    display:block;
    padding:10px;
    text-decoration:none;
    color:black;
}

.profile-dropdown a:hover{
    background:#f1f1f1;
}

/* CATEGORIES */
.categories{
    background:transparent;
    display:flex;
    gap:12px;
    padding:12px 20px;
    align-items:center;
    overflow:auto;
}
.category{
    cursor:pointer;
    font-weight:600;
    padding:8px 14px;
    border-radius:20px;
    color:#333;
    background: #fff;
    border:1px solid rgba(0,0,0,0.04);
    box-shadow:0 1px 4px rgba(0,0,0,0.04);
}
.category.active{
    background:#e8f0ff;
    color:#2874f0;
    border-color:rgba(40,116,240,0.14);
    box-shadow:0 4px 14px rgba(40,116,240,0.08);
}

/* PRODUCTS */
.section{
    margin:18px 20px;
}

.products{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:18px;
}

.card{
    background:#fff;
    border-radius:12px;
    padding:12px;
    box-shadow:0 6px 20px rgba(15,30,60,0.06);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    transition:transform .12s ease, box-shadow .12s ease;
}
.card:hover{ transform:translateY(-6px); box-shadow:0 12px 30px rgba(15,30,60,0.08); }

.img-box{
    height:160px;
    width:100%;
    border-radius:10px;
    overflow:hidden;
    background:#fafafa;
    display:flex;
    align-items:center;
    justify-content:center;
}

.slide-img{
    max-width:100%;
    max-height:100%;
    object-fit:contain;
}

.price{
    font-size:16px;
    color:#12a454;
    font-weight:700;
    margin-top:10px;
}

.model-name{ margin-top:6px; font-weight:700; color:#222; }

/* WISHLIST */
.wishlist-btn{
    margin-top:10px;
    background:#ff4d88;
    color:white;
    border:none;
    padding:8px 16px;
    border-radius:999px;
    cursor:pointer;
    font-weight:600;
    box-shadow:0 6px 18px rgba(255,77,136,0.12);
    transition:background .12s ease, transform .08s ease;
}
.wishlist-btn:active{ transform:scale(.98) }
.wishlist-btn.added{
    background:#28a745;
    box-shadow:0 6px 18px rgba(40,164,84,0.12);
}

/* Responsive tweaks */
@media (max-width:700px){
    .search-box{ flex-basis:100%; padding:8px 0 }
    .categories{ padding:10px }
    .section{ margin:12px 12px }
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <div class="logo">MyShop</div>

    <div class="search-box">
        <input type="text" id="search" placeholder="Search">
        <input type="number" id="minPriceInput" placeholder="Min ₹">
        <input type="number" id="maxPriceInput" placeholder="Max ₹">

        <select id="sortPrice">
            <option value="">Sort</option>
            <option value="low">Low → High</option>
            <option value="high">High → Low</option>
        </select>

        <button id="resetFilters">Reset</button>
    </div>

    <div class="header-links">
        <div class="profile-menu">
            <img src="{{ session.user.profile_image if session.user.profile_image else '/static/uploads/default.png' }}"
                 class="profile-img"
                 onclick="toggleProfileMenu()">
            <div class="profile-dropdown" id="profileDropdown">
                <a href="/profile">My Profile</a>
                <a href="/wishlist">My Wishlist</a>
                <a href="/sell">Sell</a>
                <a href="/logout" style="color:red;">Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- CATEGORIES -->
<div class="categories">
    <div class="category active" data-type="" onclick="filterType('')">All</div>
    <div class="category" data-type="Electronic" onclick="filterType('Electronic')">Electronics</div>
    <div class="category" data-type="Bike" onclick="filterType('Bike')">Bike</div>
    <div class="category" data-type="Car" onclick="filterType('Car')">Car</div>
</div>

<!-- PRODUCTS -->
<div class="section">
    <h3>Best Deals for You</h3>
    <div class="products" id="products"></div>
</div>

<script>
let allItems=[];
let wishlistItems = JSON.parse('{{ wishlist | tojson | safe }}');
let currentType="", searchText="", sortOrder="";
let minPriceValue = 0;
let maxPriceValue = Infinity;

let globalIndex = 0;
let globalTimer = null;

/* INPUT ELEMENTS */
const searchInput = document.getElementById("search");
const minInput = document.getElementById("minPriceInput");
const maxInput = document.getElementById("maxPriceInput");
const sortInput = document.getElementById("sortPrice");
const resetBtn = document.getElementById("resetFilters");

/* LOAD ITEMS */
fetch("/get-items")
.then(r=>r.json())
.then(d=>{
    allItems = d;
    applyFilters();
});

/* FILTER HANDLERS */
function filterType(t){ currentType=t; applyFilters(); }
function filterType(t){
    currentType = t;
    document.querySelectorAll('.category').forEach(el=>{
        el.classList.toggle('active', (el.dataset.type||'') === (t||''));
    });
    applyFilters();
}

searchInput.oninput = () => {
    searchText = searchInput.value.toLowerCase();
    applyFilters();
};

minInput.oninput = () => {
    minPriceValue = Number(minInput.value) || 0;
    applyFilters();
};

maxInput.oninput = () => {
    maxPriceValue = Number(maxInput.value) || Infinity;
    applyFilters();
};

sortInput.onchange = () => {
    sortOrder = sortInput.value;
    applyFilters();
};

resetBtn.onclick = () => {
    currentType="";
    searchText="";
    minPriceValue=0;
    maxPriceValue=Infinity;
    sortOrder="";

    searchInput.value="";
    minInput.value="";
    maxInput.value="";
    sortInput.value="";

    showItems(allItems);
};

/* APPLY FILTERS */
function applyFilters(){
    let filtered = allItems.filter(i=>{
        let p = Number(i.price) || 0;
        return (!currentType || i.type === currentType) &&
               (i.model.toLowerCase().includes(searchText) ||
                i.type.toLowerCase().includes(searchText)) &&
               p >= minPriceValue &&
               p <= maxPriceValue;
    });

    if(sortOrder==="low") filtered.sort((a,b)=>a.price-b.price);
    if(sortOrder==="high") filtered.sort((a,b)=>b.price-a.price);

    showItems(filtered);
}

/* SHOW ITEMS */
function showItems(items){
    let html="";
    items.forEach(i=>{
        let isAdded = wishlistItems.includes(i.id);
        html+=`
        <div class="card" onclick="openItem('${i.id}')">
            <div class="img-box">
                <img src="${i.images?.[0]||''}"
                     class="slide-img"
                     data-images='${JSON.stringify(i.images||[])}'>
            </div>

            <div class="price">₹ ${i.price}</div>
            <div class="model-name">${i.model}</div>

            <button class="wishlist-btn ${isAdded ? 'added' : ''}"
                onclick="toggleWishlist(event,this,'${i.id}')">
                ${isAdded ? '✓ Added' : '❤️ Wishlist'}
            </button>
        </div>`;
    });

    products.innerHTML = html;
    startGlobalSlider();
}

/* GLOBAL IMAGE SLIDER (ALL SAME TIME, 4s) */
function startGlobalSlider(){
    if(globalTimer) clearInterval(globalTimer);

    globalTimer = setInterval(()=>{
        document.querySelectorAll(".slide-img").forEach(img=>{
            let imgs = JSON.parse(img.dataset.images || "[]");
            if(imgs.length <= 1) return;

            img.src = imgs[globalIndex % imgs.length];
        });
        globalIndex++;
    }, 4000);
}

/* OPEN ITEM */
function openItem(id){
    window.location.href="/item/"+id;
}

/* WISHLIST */
function toggleWishlist(e,btn,id){
    e.stopPropagation();
    btn.classList.toggle("added");
    
    if(btn.classList.contains("added")){
        btn.innerText = "✓ Added";
        if(!wishlistItems.includes(id)) wishlistItems.push(id);
    } else {
        btn.innerText = "❤️ Wishlist";
        wishlistItems = wishlistItems.filter(item => item !== id);
    }
    
    fetch("/toggle-wishlist/"+id);
}

/* PROFILE MENU */
function toggleProfileMenu(){
    let m=document.getElementById("profileDropdown");
    m.style.display = m.style.display==="block" ? "none" : "block";
}
</script>

</body>
</html>
